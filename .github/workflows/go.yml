name: Go

on:
  push:
    branches: [ gtk ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: Build
    runs-on: windows-latest
    steps:

    - name: Install Chocolatey packages
      uses: crazy-max/ghaction-chocolatey@v1
      with:
        args: install golang git msys2

    - name: Install MinGW packages
      run: C:\tools\msys64\usr\bin\bash -lc "pacman -Sq --noconfirm mingw-w64-x86_64-gtk3 mingw-w64-x86_64-toolchain base-devel glib2-devel pkg-config"

    - name: Patch pkg-config bug
      run: C:\tools\msys64\usr\bin\bash -lc "sed -i -e 's/-Wl,-luuid/-luuid/g' /mingw64/lib/pkgconfig/gdk-3.0.pc"

    - name: Check out code into the Go module directory
      run: C:\tools\msys64\usr\bin\bash -lc "PATH=/c/Go/bin:/c/Program\ Files/Git/bin:$PATH go get -v -t -d -tags divert github.com/Gskartwii/roblox-dissector/..."

    # - name: Download WinDivert binaries
    #   run: |
    #     wget https://reqrypt.org/download/WinDivert-2.2.0-A.zip -O ~/windivert.zip
    #     unzip ~/windivert.zip -d ~/windivert
    #
    # - name: Make -lwindivert available
    #   run: cp ~/windivert/WinDivert-2.2.0-A/x64/WinDivert.dll `go env GOPATH`/src/github.com/Gskartwii/windivert-go/libwindivert.dll

    - name: Compile
      run: C:\tools\msys64\usr\bin\bash -lc "PATH=/c/Go/bin:/c/Program\ Files/Git/bin:$PATH cd `go env GOPATH`/src/github.com/Gskartwii/roblox-dissector; go build"

    # - name: Insert WinDivert binaries
    #   run: cp ~/windivert/WinDivert-2.2.0-A/x64/WinDivert{64.sys,.dll} `go env GOPATH`/src/github.com/Gskartwii/roblox-dissector/deploy/windows/

    - name: Copy artifacts
      run: C:\tools\msys64\usr\bin\bash -lc "PATH=/c/Go/bin:/c/Program\ Files/Git/bin:$PATH (mkdir /c/artifacts; cp `go env GOPATH`/src/github.com/Gskartwii/roblox-dissector/roblox-dissector.exe /c/artifacts/)"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: windows-binary
        path: C:\artifacts
